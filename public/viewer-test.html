<!DOCTYPE html>
<html>
<head>
    <title>Test Viewer</title>
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css">
</head>
<body>
    <div id="viewer" style="width: 100%; height: 100vh;"></div>
    
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
    <script>
        console.log('üöÄ Starting viewer test...');
        
        const urn = 'dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6Ynpja29meW52ZTJ3NHJwem55bW9vYnlhZ3VxeGt3ZWwvMTc1NjU2ODg1MjU1Ny1yZXNpZGVudGlhbCUyMGZsb29yJTIwcGxhbiUyMGZvciUyMHRlc3QuZHhm';
        
        async function getToken() {
            console.log('üîë Getting token...');
            try {
                const response = await fetch('/api/auth/token');
                const data = await response.json();
                console.log('‚úÖ Token obtained');
                return data.access_token;
            } catch (error) {
                console.error('‚ùå Token error:', error);
                throw error;
            }
        }
        
        console.log('üîß Initializing Autodesk Viewer...');
        Autodesk.Viewing.Initializer({ env: 'AutodeskProduction', getAccessToken: getToken }, () => {
            console.log('‚úÖ Viewer SDK initialized');
            
            const viewerDiv = document.getElementById('viewer');
            console.log('üì∫ Viewer div:', viewerDiv);
            
            const viewer = new Autodesk.Viewing.GuiViewer3D(viewerDiv);
            console.log('‚úÖ Viewer created');
            
            const startResult = viewer.start();
            console.log('‚úÖ Viewer started:', startResult);
            
            const documentId = 'urn:' + urn;
            console.log('üìÑ Loading document:', documentId);
            
            Autodesk.Viewing.Document.load(documentId, (doc) => {
                console.log('üìÑ Document loaded successfully');
                console.log('üîç Document root:', doc.getRoot());
                
                // Try multiple approaches
                let viewables = doc.getRoot().getDefaultGeometry();
                console.log('üéØ Default geometry:', viewables);
                
                if (!viewables) {
                    const all2D = doc.getRoot().search({'type': 'geometry', 'role': '2d'});
                    console.log('üéØ 2D geometries found:', all2D.length);
                    viewables = all2D.length > 0 ? all2D[0] : null;
                }
                
                if (!viewables) {
                    const allGeometry = doc.getRoot().search({'type': 'geometry'});
                    console.log('üéØ All geometries found:', allGeometry.length);
                    viewables = allGeometry.length > 0 ? allGeometry[0] : null;
                }
                
                if (viewables) {
                    console.log('üöÄ Loading viewable:', viewables);
                    viewer.loadDocumentNode(doc, viewables).then(() => {
                        console.log('üéâ MODEL LOADED SUCCESSFULLY!');
                        viewer.fitToView();
                        console.log('üéØ Fitted to view');
                    }).catch(error => {
                        console.error('‚ùå Load viewable error:', error);
                    });
                } else {
                    console.error('‚ùå No viewables found at all!');
                }
            }, (errorCode, errorMsg) => {
                console.error('‚ùå Document load failed:', errorCode, errorMsg);
            });
        }, (error) => {
            console.error('‚ùå Viewer initialization failed:', error);
        });
    </script>
</body>
</html>